##Load packages
```{r Load packages}
library(lubridate)
```
##Download data and documentation, create log file and load the data in R
```{r Download data and documentation, cache=TRUE}
link_data <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
link_doc1 <- "https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf"
link_doc2 <- "https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf"
date <- date()
##create directory for raw data
if(!file.exists("./raw_data")) {
      dir.create("./raw_data")
      }
##download data and create log file of the download
if(!file.exists("./raw_data/StormData.csv.bz2")) {
      link <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
      date <- date()
      log <- paste("Data downloaded from:", link, "on", date, sep = " ")
      write.table(log, "./raw_data/data_access_log.txt")
      download.file(link_data, 
                    "./raw_data/StormData.csv.bz2", 
                    method = "curl")
      rm(date, link, log)
      }
##download documentation
if(!file.exists("./raw_data/StormDataDoc.pdf")) {
      download.file(link_doc1, 
                    "./raw_data/StormDataDoc.pdf", 
                    method = "curl")
      }
if(!file.exists("./raw_data/StormDataFAQ.pdf")) {
      download.file(link_doc2, 
                    "./raw_data/StormDataFAQ.pdf", 
                    method = "curl")
      }
```

##read the data
```{r Read the data, cache=TRUE}
if(!exists("StormData")) {
      StormData <- read.csv(bzfile("./raw_data/StormData.csv.bz2"), stringsAsFactors = FALSE, header = TRUE)
      }

rm(link, link_doc1, link_doc2)
```


##Pre-processing
Check the headings of the original dataset
```{r Headings of the dataset}
names(StormData)
```
Select relevant columns
```{r Select relevant columns, cache=TRUE}
df <- with(StormData, 
           data.frame(state = STATE,
                      bgn_date = as.Date(as.character(StormData$BGN_DATE), format = "%m/%d/%Y"),
                      evtype = as.factor(EVTYPE), 
                      fatalities = FATALITIES, 
                      injuries = INJURIES, 
                      propdmg = PROPDMG, 
                      propdmgexp = PROPDMGEXP, 
                      cropdmg = CROPDMG, 
                      cropdmgexp = CROPDMGEXP,
                      remarks = REMARKS)
           )
```

##analysis of the dataset

EVTYPE.txt is a list of the EVTTYPE taken from the documentation downloaded as StormDataDoc.pdf (p.6, table 1. Storm Data Event Table)
```{r Analysis of the dataset, cache=TRUE}
evtype_doc <- scan("./raw_data/EVTYPE.txt", what = "", sep = "\n")#read the list
evtype_doc <- substr(evtype_doc, 1, nchar(evtype_doc) - 2)#remove the character "designator"
evtype_data <- as.character(levels(df$evtype))
```
The difference between EVTYPE's categories of the documentation and the data
```{r}
cbind(EVTYPE.DOCUMENTATION = length(evtype_doc), EVTYPE.DATA = length(levels(df$evtype)))
print(evtype_doc)
print(evtype_data)
#cleaning EVTYPE

```

```{r}
#conditions
passage_num1 <- gsub("/|\\(|\\)"," ",evtype_doc)
passage_num1 <- data.frame(grep = passage_num1, output = passage_num1)
#cleaning function
clean_evtype <- function(subject = "evtype_data", passage_num = 1){
      evtype_clean <- data.frame(evtype_data, stringsAsFactors = FALSE)
      for(j in 1:passage_num){
            cond_title <- paste("passage_num", j, "_output", sep = "")
            evtype_clean[ , cond?_title] <- NA #add output column
            cond <- get(paste("passage_num", j, sep = ""), envir = .GlobalEnv)
            cond <- data.frame(grep = as.character(cond$grep), 
                               output = as.character(cond$output), stringsAsFactors = FALSE)
            for(i in 1:length(cond$grep)) {
                  index <- grep(cond$grep[i], evtype_clean$evtype, ignore.case = TRUE)
                  if(j > 1) {
                        cond_title_previous <- paste("passage_num", j - 1, "_output", sep = "")
                        if(is.na(evtype_clean[index, cond_title_previous])) {
                              evtype_clean[index, cond_title] <- cond$output[i]
                              }
                        }
                  else {
                        evtype_clean[index, 
                                     cond_title] <- evtype_clean[index, 
                                                                 cond_title_previous]
                        }
                  }
            }
      evtype_clean <<- evtype_clean
      }
clean_evtype(passage_num = 1)

```
The first passage gives these results 
```{r}
print(evtype_clean)
```
Second passage
```{r}
